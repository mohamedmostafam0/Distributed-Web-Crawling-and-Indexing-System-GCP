<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web Crawling System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .nav-tabs .nav-link {
        color: #495057;
      }
      .nav-tabs .nav-link.active {
        color: #0d6efd;
        font-weight: bold;
      }
      .card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .progress {
        height: 25px;
      }
      .health-indicator {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
      }
      .health-good {
        background-color: #28a745;
      }
      .health-warning {
        background-color: #ffc107;
      }
      .health-bad {
        background-color: #dc3545;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid py-4">
      <h1 class="text-center mb-4">Web Crawling System</h1>

      <!-- Navigation Tabs -->
      <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="crawl-tab"
            data-bs-toggle="tab"
            data-bs-target="#crawl"
            type="button"
            role="tab"
          >
            New Crawl
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="search-tab"
            data-bs-toggle="tab"
            data-bs-target="#search"
            type="button"
            role="tab"
          >
            Search URLs
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="index-tab"
            data-bs-toggle="tab"
            data-bs-target="#index"
            type="button"
            role="tab"
          >
            Search Index
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="progress-tab"
            data-bs-toggle="tab"
            data-bs-target="#progress"
            type="button"
            role="tab"
          >
            Monitor Progress
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="health-tab"
            data-bs-toggle="tab"
            data-bs-target="#health"
            type="button"
            role="tab"
          >
            System Health
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="myTabContent">
        <!-- New Crawl Tab -->
        <div class="tab-pane fade show active" id="crawl" role="tabpanel">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Start New Crawl</h5>
              <form method="POST" action="/">
                <div class="mb-3">
                  <label for="seed_urls" class="form-label"
                    >Seed URLs (one per line)</label
                  >
                  <textarea
                    class="form-control"
                    id="seed_urls"
                    name="seed_urls[]"
                    rows="3"
                    required
                  ></textarea>
                </div>
                <div class="mb-3">
                  <label for="depth_limit" class="form-label"
                    >Crawl Depth</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="depth_limit"
                    name="depth_limit"
                    value="1"
                    min="1"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label for="domain_restriction" class="form-label"
                    >Domain Restriction (optional)</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="domain_restriction"
                    name="domain_restriction"
                  />
                </div>
                <button type="submit" class="btn btn-primary">
                  Start Crawling
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Search URLs Tab -->
        <div class="tab-pane fade" id="search" role="tabpanel">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Search Crawled URLs</h5>
              <div class="mb-3">
                <input
                  type="text"
                  class="form-control"
                  id="urlSearch"
                  placeholder="Enter URL to search"
                />
              </div>
              <button class="btn btn-primary" onclick="searchUrls()">
                Search
              </button>
              <div id="urlResults" class="mt-3">
                <!-- Results will be displayed here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Search Index Tab -->
        <div class="tab-pane fade" id="index" role="tabpanel">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Search Index</h5>
              <div class="mb-3">
                <input
                  type="text"
                  class="form-control"
                  id="indexSearch"
                  placeholder="Enter keywords to search"
                />
              </div>
              <button class="btn btn-primary" onclick="searchIndex()">
                Search
              </button>
              <div id="indexResults" class="mt-3">
                <!-- Results will be displayed here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Monitor Progress Tab -->
        <div class="tab-pane fade" id="progress" role="tabpanel">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Crawling Progress</h5>
              <div class="mb-3">
                <label>URLs Crawled</label>
                <div class="progress">
                  <div
                    class="progress-bar"
                    role="progressbar"
                    style="width: {{ metrics.urls_crawled }}%"
                  ></div>
                </div>
                <small class="text-muted"
                  >{{ metrics.urls_crawled }} URLs crawled</small
                >
              </div>
              <div class="mb-3">
                <label>URLs Indexed</label>
                <div class="progress">
                  <div
                    class="progress-bar"
                    role="progressbar"
                    style="width: {{ metrics.urls_indexed }}%"
                  ></div>
                </div>
                <small class="text-muted"
                  >{{ metrics.urls_indexed }} URLs indexed</small
                >
              </div>
            </div>
          </div>
        </div>

        <!-- System Health Tab -->
        <div class="tab-pane fade" id="health" role="tabpanel">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">System Health</h5>
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Component</th>
                      <th>Status</th>
                      <th>Last Check</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Crawler</td>
                      <td>
                        <span class="health-indicator health-good"></span>
                        Running
                      </td>
                      <td>Just now</td>
                    </tr>
                    <tr>
                      <td>Indexer</td>
                      <td>
                        <span class="health-indicator health-good"></span>
                        Running
                      </td>
                      <td>Just now</td>
                    </tr>
                    <tr>
                      <td>Storage</td>
                      <td>
                        <span class="health-indicator health-good"></span>
                        Connected
                      </td>
                      <td>Just now</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function searchUrls() {
        const searchTerm = document.getElementById("urlSearch").value;
        const resultsDiv = document.getElementById("urlResults");

        fetch(`/search/urls?q=${encodeURIComponent(searchTerm)}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              resultsDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
              return;
            }

            let html = '<div class="list-group">';
            data.results.forEach((result) => {
              html += `
                <div class="list-group-item">
                  <div class="d-flex justify-content-between align-items-center">
                    <a href="${result.url}" target="_blank">${result.url}</a>
                    <small class="text-muted">Last crawled: ${result.last_crawled}</small>
                  </div>
                </div>
              `;
            });
            html += "</div>";
            resultsDiv.innerHTML = html;
          })
          .catch((error) => {
            resultsDiv.innerHTML = `<div class="alert alert-danger">Error searching URLs: ${error}</div>`;
          });
      }

      function searchIndex() {
        const searchTerm = document.getElementById("indexSearch").value;
        const resultsDiv = document.getElementById("indexResults");

        fetch(`/search/index?q=${encodeURIComponent(searchTerm)}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              resultsDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
              return;
            }

            let html = '<div class="list-group">';
            data.results.forEach((result) => {
              html += `
                <div class="list-group-item">
                  <h6 class="mb-1"><a href="${result.url}" target="_blank">${result.title}</a></h6>
                  <p class="mb-1">${result.snippet}</p>
                  <small class="text-muted">${result.url}</small>
                </div>
              `;
            });
            html += "</div>";
            resultsDiv.innerHTML = html;
          })
          .catch((error) => {
            resultsDiv.innerHTML = `<div class="alert alert-danger">Error searching index: ${error}</div>`;
          });
      }

      function updateHealthStatus() {
        fetch("/health")
          .then((response) => response.json())
          .then((data) => {
            const healthTable = document.querySelector("#health table tbody");
            healthTable.innerHTML = "";

            Object.entries(data).forEach(([component, info]) => {
              const statusClass =
                info.status === "running" || info.status === "connected"
                  ? "health-good"
                  : "health-bad";

              healthTable.innerHTML += `
                <tr>
                  <td>${
                    component.charAt(0).toUpperCase() + component.slice(1)
                  }</td>
                  <td><span class="health-indicator ${statusClass}"></span> ${
                info.status
              }</td>
                  <td>${new Date(info.last_check).toLocaleString()}</td>
                </tr>
              `;
            });
          })
          .catch((error) =>
            console.error("Error fetching health status:", error)
          );
      }

      // Auto-refresh progress and health every 5 seconds
      setInterval(() => {
        if (
          document.getElementById("progress-tab").classList.contains("active")
        ) {
          // TODO: Implement progress refresh
        }
        if (
          document.getElementById("health-tab").classList.contains("active")
        ) {
          updateHealthStatus();
        }
      }, 5000);

      // Initial health check
      updateHealthStatus();
    </script>
  </body>
</html>
